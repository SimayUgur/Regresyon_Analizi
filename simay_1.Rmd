---
title: "sınav_1"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Soru1 Regression

```{r gerekli kütüphaneler}
library(caret)
library(Hmisc)
library(ggplot2)
library(tidyverse)
library(AppliedPredictiveModeling)
library(pls) #kismi en kucuk kareler ve pcr icin
library(elasticnet)
library(broom) #tidy model icin
library(glmnet)
library(MASS)
library(ISLR)
library(PerformanceAnalytics)
library(funModeling)
library(Matrix)
library(caret)
library(tidyverse)
library(pls) #kismi en kucuk kareler ve pcr icin
library("car")
library("olsrr")
library("GGally")
library(corrplot)
library(Matrix)
library(olsrr)
library("car")
library("ISLR")
library(broom) #tidy model icin
library(glmnet)
library(MASS)
library(ISLR)
library("knitr")
library("rmarkdown")
library("corrplot")
library("Hmisc")
library("corrplot")
library("car")
library("olsrr")
library("GGally")
library(nortest)


```

## veri işleme _veriye genel bakış

#

```{r}
df <- ISLR::Hitters
rownames(df) <- c()#row namesleri sildim veriye daha güzel bakabiliriz.
glimpse(df)
```


```{r}
# NA's olanları silelim
df <- na.omit(df)
sum(ifelse(is.na(df), 1, 0))
```


```{r}
#Columnları filtreyelim
# CRuns-11,Walks-6,Years-7,Division,CRBI-12,CWalks-13,NewLeague-20,CAtBat,PutOuts en sona Salarayi attım
df <- df[,c(6, 7, 8, 11, 12, 13, 15, 16, 20, 19)]
head(df)

```
Train-TEST
```{r}
set.seed(123)
smp_size <- round(0.7 * nrow(df))
train_ind <- sample(x = nrow(df),size = smp_size,replace = F)
train <- df[train_ind,]
test <- df[-train_ind,]
```





### 1) Matris Plot oluşturarak yorumlayınız
```{r}

plot(train)

```



Gelişmiş Scatter plot:
```{r}
chart.Correlation(train %>% dplyr::select(-c("NewLeague","Division")), histogram=TRUE, pch=19)

```

Yorum:
Salary bağımlı değişkenim ile Cruns bağımsız değişknenim arasında pozitif yönlü güçlü ilşkivar.Scatter plottanda ikilinin yönünü ve şeklini görebiliyoruz doğrusalilerlemiş noktalar.

Bağımsız değişkenlerim arasında güçlü bir korelasyon ilşkisi var.Bu benim istemediğim bir durum.Bağımsız değişkenler arsaında güçlü ilşki olmamalı.İleride çoklu doğrusal bağlantı sorununa neden olabilir.


###2) Korelasyon matrisi ve korelasyon katsayılarına ilişkin p değerlerini matrisini  elde ederek, %5 önem düzeyinde anlamlı korelasyon katsayılarını belirleyiniz. 

```{r}
#ilk başta korelasyon .
cormatris <- as.matrix(train[,-c(7,9)])
matris1 <-Hmisc::rcorr(cormatris)
matris1$r



```

```{r}
matris1 <-Hmisc::rcorr(cormatris)
matris1$r
corrplot::corrplot(matris1$r, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
matris1$P

```
1987 yılında oyuncuların açılış maaşları(salary) bağımlı olduğu için onunla ilgili değerlerin yüksek çıkması normal olarak görülmektedir.
p degerleri oldukça iyidir. Hepsi sıfıra yakınsamaktadır yani yaklaşık sıfır değeri almıştır önem düzeyinde anlamlı korelasyon katsayılarına sahiptir.Bağımlı "Salary" değişkenimiz ile diğer bağımsız değişkenlerin korelasyonu anlamlıdır diyebirim.


aşağıda görüğümüz Corrplotta yine maviler yüksek korelesyonlu pozitif yönlü ilişikiyi emsil etmektedir.
Salary bağımsız değişknemile diğer bağımlı değişkenlerim arasında örneğin CWalksarasında pozitif yönlü güçlü bir ilşki vardır.
Maaşın ile 1986'daki çıkış sayısı(Putouts)arasında pozitif yönlü güçlü olmayan bir ilişki var.

```{r}
corrplot::corrplot(matris1$r, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)


```

3)Çoklu doğrusal regresyon modelini elde ediniz ve model geçerliliğini sıfır ve alternatif
hipotezleri belirterek %5 önem düzeyinde test ediniz.

```{r}
model<-lm(Salary~Walks+Years+CAtBat+CRuns+CRBI+CWalks+Division+PutOuts+NewLeague, data = train)
summary(model)

```

1987 yılı lig açılış gününde yıllık maaş(Salary) tahmin etmek için; yürüyüş sayısı(walks),,years,Catbat (Kariyeri boyunca catbat  sayısı),Crun(Kariyeri sırasındaki koşu sayısı),CRBI,CWalks ,Putouts,  DivisionW,NewLeagueN  değişkenleri ile full bir model oluşturuldu.


Değişkenlerden "Years", "Putouts" ,b0 önem düzeyinde anlamlı değildir.
Diğer değişkenlerin t istatistiklerinin olasılık değeri 0.05 aşağısında olduğundan anlamlı gözükmektedir.Modelde bulunan diğer değişkenler anlamlıdır. F istatistiği <2e-16<0.05
olduğu için H0 hipotezi red edilir ve en az bir tane ß 0 dan farklıdır yorumu yapılır.

Yıllık maaştaki(salary) değişimin %58’i açıklayıcı değişkenler tarafından
açıklanmaktadır.


###4)Hipotezleri yazarak, elde ettiğiniz modeldeki anlamlı katsayıları belirleyiniz. 
Katsayıların Yorumları:

H0 : β0  (Sabit terimin modele katkısı anlamlı değildir.)
H1 : β0  (Sabit terimin modele katkısı anlamlıdır.)
p- value=0.177419 değeri 0.05’den büyük olduğundan dolayı H0  hipotezimiz reddedilemez  yani sabit terimin *modele katkısı anlamlı değildir*.



Walks
H0: ß1 = 0
H1: ß1 != 0
p = 0.000563     p-value değeri=0.000563 , 0.05’den küçük olduğu için H0 hipotezimiz reddedilir.yani Walksın *modele katkısı anlamlıdır.*

Years
H0: ß2 = 0
H1: ß2 != 0         
p = 0.259522        

p- value=0.259522 değeri 0.05’den büyük olduğundan dolayı H0  hipotezimiz reddedilemez  yani Years modele*katkısı anlamlı değildir.*

CAtBat
H0: ß3 = 0
H1: ß3 != 0
p = 0.022878      H0 hipotezimiz red. Değişken anlamlıdır.

CRuns
H0: ß4 = 0
H1: ß4 != 0
p = 0.000103 ***      p-value değeri=0.000103 , 0.05’den küçük olduğu için H0 hipotezimiz reddedilir.yani Crun *modele katkısı anlamlıdır.*

CRBI
H0: ß5 = 0
H1: ß5 != 0
p = 0.004850      p-value değeri=0.0048 , 0.05’den küçük olduğu için H0 hipotezimiz reddedilir. *Değişken anlamlıdır.*

CWalks
H0: ß6 = 0
H1: ß6 != 0
p = 0.001614   p-value değeri 0.001614 0.05’den küçük olduğu için H0 hipotezimiz reddedilir. *Değişkenimiz anlamlıdır.*

DivisionW
H0: ß7 = 0
H1: ß7 != 0
p = 0.005216   p-value değeri=0.005216 ** , 0.05’den küçük olduğu için H0 hipotezimiz reddedilir.yani Divisionın *modele katkısı anlamlıdır.*

PutOuts
H0: ß8 = 0
H1: ß8 != 0
p = 0.099928      p-value değeri 0.099928 0.05’den büyük olduğu için H0 hipotezimiz reddedilemez. Değişken anlamlı değildir *modele katkısı yoktur.*
.

NewLeagueN
H0: ß9 = 0
H1: ß9 != 0
p = 0.046459   p-value değeri 0.046459 0.05’den küçük olduğu için H0 hipotezimiz reddedilir. *Değişkenimiz anlamlıdır.*  


##5. VIF değerlerini hesaplayınız ve yorumlayınız.
```{r}
vif(model)

```
Walks,Divison,Putouts,Newleauqe açıklayıcı değişkenlerimiz hariç diğer bütn değişkenlerin Vif değeri>5tir.Yani diğer bağımsız değişkenlerimde*çoklu doğrusal bağlantı*sorunu vardır.

##6En iyi olası alt küme değişken seçim yöntemini uygulayarak alternatif iki model belirleyiniz. Gerekçelerini belirtiniz.
```{r}
olsrr::ols_step_best_subset(model)
```

Çoklu doğrusal bağlantı sorunu olmayan ve cp değeri en az yanlı olan, adjusted r-squared ve r-squared birbirine yakın, AIC ve SBIC mümkün olan en düşük, parametrelerin p-değerlerinin %5 önem düzeyinde anlamlı olduğu mümkün olan en iyi model aşağıdaki çıkmıştır.


```{r}
model1<-lm(Salary~Walks+CAtBat+CRuns+CRBI+CWalks+Division+PutOuts+NewLeague,data=train)
summary(model1)
```


```{r}
vif(model1)
```
best_yeni kurmuş olduğum en iyi modelde çoklu doğrusal bağlantı sorunnu var.

```{r}
model2=lm(Salary~Years+CRuns+Division+PutOuts,data=train)
  #formul <- train$Salary~train$Years + train$CRuns + train$Division + train$PutOuts
#model2 <- lm(formul)
summary(model2)
```


```{r}
#bütün katsayılar anlamlı vif()bakalım
vif(model2)
```
çoklu doğrusal bağlantı sorunum bu değişkenleri model2 ye alarak çözülmüş oldu.
Son bir model daha deneyelim.
```{r}
model3 <-  lm(Salary~Walks+CRuns+CWalks+Division+PutOuts, data = train)
summary(model3)
car::vif(model3)
```

CRuns,CWalks vif değerlerim>5 olduğundan model3 te  çoklu doğrusal bağlantı sorunu var.
En iyi elde ettiğim model2 olmuş oldu bağımsız değişkenlerin vif değerleri <5 oldu.

Sonuç olarak olabilecek en iyi modeli bulabilme için ols_step_best_subset(model) yöntemini uygulayarak bana alternatif modeller sundu.ols_step_best_subset(model) verdiği AIC, R^,adj_r2, Cp değerlerine bakarak olabilecek alternatif 3 model oluşturdum.R^2 değeri yüksek ve R^2 adjusted R^2 değerleri birbirine yakın,CP değeri düşük,Aıc değeri düşükolan mode seçimi en doğrusu olacaktır.
Model1 ,model3 te çoklu doğrusal bağlantı sorunu vardı.model2 ise summary(model2) de tüm değişkenler anlamlı,model anlamlı ve vif değerleri bütün bağımsız değişkenlerin 5  altındaydı.


### 7) Alternatif modellerin tahmin performansını test seti üzerinde PRESS değerini dikkate alarak inceleyiniz ve en uygun modele karar veriniz.
```{r}
pred2 <- predict(model2, test)
press2 <- Metrics::rmse(pred2, test$Salary)
print(press2)
```


```{r}

pred3 <- predict(model3, test)
press3 <- Metrics::rmse(pred3, test$Salary)
print(press3)

```

Sonuç:Pres değeri MOdel3=331,3998dir. Press değerimodel2'nin 384.9864tür.
Fakat Model3 te çoklu doğrusal bağlantı sorunu olduğundan model2 ile devam ederim.

### 8) Hipotezleri yazarak, hataların normal dağıldığı varsayımını grafikle ve uygun istatistiksel test ile kontrol ediniz. (α=0.05) (4 p.)

```{r}
plot(model2)
```


#####Normallik varsayımı
Normallik varsayımı:
Gözlem sayımız 50den az olmadığı için shapiro-whilk testi kullanılamamaktadır. Kolmogorov-Smirnov testi kullanılacaktır.
H0:Hatalar normal dağılım varsayımına uyar.
H1:Hatalar normal dağılım varsayımına uymaz.

```{r}
 
st.res <- model2$residuals / sd(model2$residuals) 
ks.test(st.res, y = "pnorm")

```

```{r}
hist(st.res)
```
One-sample Kolmogorov-Smirnov testine göre hatalar normal dağılır.p-value>0.05
Normal dağılır Varsayımı sağlanır.

#### 9) Hipotezleri yazarak, hataların sabit varyanslı olup olmadığını grafikle ve uygun istatistiksel test ile kontrol ediniz. (α=0.05) 
H0:Hatalar sabit varyanslıdır.
H1:Hatalar sabit varyanslı değildir.
```{r}
library(asympTest)
asymp.test(Salary~CRuns, data =train,na.action = na.omit, parameter = "dVar")

```

```{r}
car::ncvTest(model2)
```
Modelde ki Hatalar sabit varyanslı değildir. HO red.
#### 10) Uç değer ve etkin gözlem olup olmadığını grafiklerle ve ilgili değerlerle belirleyiniz.
```{r}
plot(model2$fitted.values, st.res)
abline(h = 0, lty = 2)
abline(h = c(-2,2), col = "red")

```
uç değerli gösteren grafik çizdik.uç değerlerimiz mevcut.

---
```{r}
cutoff <- 4/(length(train$Salary)-5)
plot(model2, which=4, cook.levels=cutoff)
```
74,101,218. gözzler Cooks distansela ortaya çıkmıştır. Bunlar benim etkin gözlemlerim.

--
*Hat-Value* ve *Cook's Distance* kriterlerine bakılarak sorun yaratacak gözlemler  modelden çıkartılmalıdır.
```{r}
bad_lev <- which(abs(st.res)>2 & hatvalues(model2)> 2*mean(hatvalues(model2)))
bad_lev
```
Bu gözlemleri çıkartarak bütün aşamaları Tekrarlıyacağız.
```{r}
require(dplyr)
df2 <- df[-bad_lev,]
df2 <- df2[-c(128),]
set.seed(123)
smp_size2 <- round(0.7 * nrow(df2))
train_ind2 <- sample(x = nrow(df2),size = smp_size2,replace = F)
train2 <- df2[train_ind2,]
test2 <- df2[-train_ind2,]


```
Belirlediğimiz gözlemleri çıkardıktan sonra modeli tekrar kuracak ve varsayımları kontrol edeceğiz.

```{r}
model4 <- lm(Salary~Years + CRuns + Division + PutOuts, data=train2)
summary(model4)
plot(model4)
st.res4 <- model4$residuals / sd(model4$residuals) 
stats::ks.test(st.res4, y = "pnorm")
car::ncvTest(model4)

```
Normallik varsayımı sağlanmaktadır fakat değişen varyans sorunu devam etmektedir. Ağırlıklandırılmış regresyon deneyeceğiz.

```{r}

# artıkların mutlak değeri
abs_res <- abs(model4$residuals)
# fitted valuelar
fitted_val <- model4$fitted.values
# ağırlıklandırılmak için böyle bir method izleyeceğiz. wts değişkenini modelimizi ağırlıklandırmak için kullanacağız.
wts <- 1/fitted(lm(abs_res ~ fitted_val))^2
# ağırlıklandırılmış model:
model5 <- lm(Salary~Years + CRuns + Division + PutOuts, data = train2, weights = wts)

summary(model5)



```

```{r}
plot(model5)
st.res5 <- model5$residuals / sd(model5$residuals) 


```
```{r}
stats::ks.test(st.res5, y = "pnorm")
car::ncvTest(model5)

```
 ###11. Modelde yer alan iki değişkene ait katsayıyı yorumlayınız.
```{r}
summary(model5)

```

yorum:
Modelde bulunan Intecrpt,Cruns,PutOutputs değişkenler yüksek oranda anlamlı çıkmıştır. F istatistiği 4.083e-14<0.05
olduğu için hipotezi red edilir ve en az bir tane ß 0 dan farklıdır yorumu yapılır.
SAlary bağımlı değişkenindeki değişimin %32.93’ü açıklayıcı değişkenler
tarafından açıklanmaktadır.
```{r}
model5$coefficients
```
Yorum:
Katsayı anamlılığı:

Byears- değişkenim  bir birim arttığında, diğer değişkenler modelde ve sabitken Maaş ortalama 15.4390 azalır.

BCRuns değişkenim bir birim arttığında ,diğer değişkenler modelde ve sabitken Salary ortalama 0.9690 artar.

PutOutputs değikenim bir birim arttığında diğer değişkenler modelde ve sabitken ortalama SAlary bağımlı değişkenim 0.2697802 artar.


### 12.Yeni bir gözlem değeri için %95’lik güven aralığını ve kestirim aralığını bularak yorumlayınız. (3 p.)


```{r}
library(stats)
confint(model5, level = 0.95)


```
*Byears* için yorum;
Years bir birim arttığında, diğer değişkenler modelde ve sabitken 
Oyuncuların maaşları(salary) %95 güvenle ortalama -33.477 ile 0.259 arasındadır.

BCruns için yorum:
CRuns bir birim arttığında , diğer değişkenler modelde ve sabitken Oyuncuların Maaşları %95 güvenle 0.64262225- 1.2955507 arasındadır. 

Bputoutputs:
PutOuts bir birim arttığında diğer değişkenler model de ve sabitken Oyuncuların maaşları %95 güvenle ortalama  0.08621687  - 0.4533435 değerleri arasındadır.


Yeni gözlem için test seti kullanılacaktır.

```{r}
#x0 Y0 için Güven aralığı tahmini.
pred_confint <- predict(model5, test2, interval = "confidence")
test_confint <- cbind(test2, pred_confint)
head(test_confint)
```
Tahmin değeri %95 güvenle lwr ve upr sütunlarındaki değerler arasında olacaktır
Walks 76,yearsı 3 , CatBAt 1621 Cruns 266  iken %95 güvenle Salary 483.8562 ile 707.1484 arasında değişir.


---
Tahmin değeri %95 güvenle lwr ve upr sütunlarındaki değerler arasında olacaktır.

```{r}
##X0 icin Y0'a ait tahmin araligi##
pred_confint1 <- predict(model5, test2, interval = "predict")
test_confint1 <- cbind(test2, pred_confint1)
head(test_confint)

```
Tahmin değeri lwr ve upr sütunlarındaki değerler arasında olacaktır
Walks 76,yearsı 3 , CatBAt 1621 Cruns 266  iken %95 güvenle Salary 438.8562 ile 707.1484 arasında değişir.



```

